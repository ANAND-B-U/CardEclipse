import os
import requests
import base64
import json

def send_image_to_ollama(image_path, prompt, model='llava'):
    with open(image_path, 'rb') as img_file:
        image_bytes = img_file.read()
        image_base64 = base64.b64encode(image_bytes).decode('utf-8')

    payload = {
        "model": model,
        "prompt": prompt,
        "images": [image_base64],
        "stream": True
    }

    response = requests.post("http://localhost:11434/api/generate", json=payload, stream=True)

    print(f"\nüñºÔ∏è Processing: {os.path.basename(image_path)}")
    for line in response.iter_lines():
        if line:
            try:
                data = json.loads(line.decode('utf-8'))
                print(data.get("response", ""), end='', flush=True)
            except json.JSONDecodeError:
                print("\n‚ö†Ô∏è Failed to decode line:", line)

def process_folder(folder_path, prompt, model='llava'):
    supported_ext = ('.jpg', '.jpeg', '.png', '.webp')
    image_files = [f for f in os.listdir(folder_path) if f.lower().endswith(supported_ext)]

    for image_file in image_files[:10]:  # Limit to first 10 images
        full_path = os.path.join(folder_path, image_file)
        send_image_to_ollama(full_path, prompt, model)

# Example usage
process_folder(r"C:\Users\Anand B\OneDrive\Desktop\html\cards", "Extract contact details from this image.")